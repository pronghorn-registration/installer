services:
    pronghorn:
        image: ghcr.io/pronghorn-registration/pronghorn:${TAG:-latest}
        ports:
            - "${HTTP_PORT:-80}:8080"
            - "${HTTPS_PORT:-443}:8443"
        environment:
            - APP_ENV=production
            - SSL_MODE=full
            - AUTORUN_ENABLED=true
            - AUTORUN_LARAVEL_STORAGE_LINK=true
            - AUTORUN_LARAVEL_OPTIMIZE=true
            - AUTORUN_LARAVEL_MIGRATION=true
            - HEALTHCHECK_PATH=/up
        volumes:
            - ./storage:/var/www/html/storage
            - ./database:/var/www/html/database
            - ./.env:/var/www/html/.env:ro
            - ./docker/ssl/fullchain.pem:/etc/ssl/private/self-signed-web.crt:ro
            - ./docker/ssl/privkey.pem:/etc/ssl/private/self-signed-web.key:ro
        networks:
            - app-network
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "curl", "-sf", "http://localhost:8080/up"]
            interval: 30s
            timeout: 5s
            retries: 3
            start_period: 45s
        depends_on:
            redis:
                condition: service_healthy

    redis:
        image: redis:7-alpine
        command: redis-server --appendonly yes
        volumes:
            - redis-data:/data
        networks:
            - app-network
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 3

networks:
    app-network:
        driver: bridge

volumes:
    redis-data:
